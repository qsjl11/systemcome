# 系统结构说明文档

## 一、系统概述
这是一个基于Flask的网页应用，模拟修仙小说中的"系统"角色。玩家作为系统，通过发布任务引导主角成长，而主角具有自主AI决策能力。

## 二、系统架构
### 1. 目录结构
```
/flask_app
   ├── app.py              # 主程序：路由和应用配置
   ├── core/              # 核心包
   │   ├── __init__.py    # 数据库初始化
   │   ├── models/        # 数据模型
   │   │   ├── __init__.py
   │   │   ├── character.py  # 角色模型
   │   │   ├── event.py     # 事件模型
   │   │   ├── save.py      # 存档模型
   │   │   └── task.py      # 任务模型
   │   ├── services/      # 业务逻辑
   │   │   ├── __init__.py
   │   │   ├── character_service.py  # 角色服务
   │   │   ├── event_service.py      # 事件服务
   │   │   ├── llm_service.py        # LLM服务
   │   │   ├── save_service.py       # 存档服务
   │   │   └── task_service.py       # 任务服务
   │   └── utils/         # 工具函数
   │       ├── __init__.py
   │       └── constants.py  # 常量定义
   ├── requirements.txt    # 项目依赖
   ├── templates/          # 前端模板
   │   └── index.html     # 主界面
   └── static/            # 静态资源
       └── style.css      # 样式定义
```

### 2. 核心组件
- **数据模型**：
  - Character：存储角色状态
    - 基础五维：气血、灵力、神识、体魄、气运
    - 境界系统：境界阶段、小境界、破境成功率
    - 灵根资质：金木水火土五行灵根
    - 性格维度：正邪倾向、决策风格、社交模式、机缘敏感、道心类型
    - 其他属性：信任值、压力值
  - Task：记录任务信息（类型、状态、奖励）
  - SaveSlot：存储游戏存档（槽位、存档时间、存档名称、压缩数据）
  - EventPool：事件池管理（事件类型、触发条件、权重、冷却时间）
  - ActiveEvent：活跃事件记录（事件状态、开始时间、完成时间、结果）

- **服务层**：
  - CharacterService：角色状态管理、属性计算
  - EventService：事件生成、评估、执行
  - LLMService：大模型交互、结果生成
  - SaveService：存档管理、数据序列化
  - TaskService：任务管理、奖励计算

- **工具类**：
  - constants.py：系统常量定义
    - 境界名称映射
    - 任务类型及效果
    - 事件类型及状态
    - 默认值配置
    - 系统参数配置

- **API接口**：
  - `/`：主页面渲染
  - `/get_status`：获取角色状态
  - `/issue_task`：发布新任务
  - `/get_ai_action`：获取AI决策
  - `/save_game`：保存游戏状态
  - `/load_game`：加载游戏存档
  - `/get_saves`：获取存档列表
  - `/refresh_events`：刷新事件池
  - `/get_active_events`：获取活跃事件
  - `/handle_event`：处理事件选择

### 3. 前端结构
- 状态区域：
  - 基础五维面板：显示气血、灵力等基础属性
  - 境界信息面板：显示当前境界、小境界和破境概率
  - 灵根资质面板：显示五行灵根资质
  - 性格维度面板：显示性格相关属性
  - 其他属性面板：显示信任值和压力值
- 操作面板：任务发布按钮和存档按钮
- 存档面板：支持10个存档位，可命名存档
- 事件日志：记录系统活动

## 三、系统特点
### 1. 设计风格
- **模块化**：核心功能分包管理
- **解耦合**：业务逻辑与数据访问分离
- **可扩展**：服务层接口标准化
- **可维护**：代码结构清晰，职责明确

### 2. 交互模式
- **事件驱动**：用户操作触发任务
- **自动更新**：定期刷新状态
- **双向互动**：系统发布任务，AI做出响应
- **数据持久化**：支持多槽位存档，保存游戏进度

### 3. 技术特点
- 前后端分离
- RESTful API设计
- 实时数据更新
- 响应式界面设计
- 数据压缩存储
- 模块化设计

## 四、重点说明
### 1. 核心功能
- 任务发布系统
- 角色状态管理
- AI决策机制
- 事件日志记录
- 游戏存档系统

### 2. 关键算法
```python
# AI决策逻辑
if stress > 70:
    action = '逃避' if decision_style < 50 else '莽撞行动'
elif spiritual_power < 150:
    action = '修炼'
else:
    explore_chance = 0.3 + (decision_style - 50) * 0.004
    action = '探索' if fortune_sensitivity > explore_chance * 100 else '社交'
```

### 3. 状态更新规则
- 战斗任务：增加气血和压力值
- 探索任务：增加灵力和神识
- 社交任务：增加信任值和气运

### 4. 存档系统特点
- 支持10个存档槽位
- 存档数据压缩存储
- 存档信息包含：
  - 角色状态数据
  - 任务记录数据
  - 事件日志数据
- 支持存档命名
- 显示存档时间

## 五、扩展性设计
系统预留了以下扩展点：
1. AI决策系统的增强
2. 事件池系统的实现
3. 剧情引擎的开发
4. 新任务类型的添加
5. 成就系统的实现
6. 自动存档功能
7. 存档数据导入导出

## 六、开发建议
1. 保持代码结构的清晰性
2. 遵循RESTful API设计规范
3. 注重用户体验和实时反馈
4. 维护良好的事件日志系统
5. 考虑系统的可扩展性
6. 定期清理过期存档
7. 优化存档数据大小

## 七、更新日志

### 2025-01-26
#### 更新三：代码重构
- 创建core包，优化代码结构
  - 将数据模型移至models目录
  - 将业务逻辑移至services目录
  - 将常量定义移至utils目录
- 优化服务层实现
  - 添加角色服务
  - 完善事件服务
  - 增强LLM服务
  - 重构存档服务
  - 添加任务服务
- 更新主程序结构
  - 简化路由实现
  - 统一错误处理
  - 优化代码组织

### 2025-01-26
#### 更新二：事件池系统与大模型集成
- 添加事件池相关数据模型
  - EventPool：事件池基础数据
  - ActiveEvent：活跃事件管理
- 实现事件管理系统
  - 事件刷新机制
  - 权重计算系统
  - 事件触发控制
- 集成大模型服务
  - 支持deepseek和openai接口
  - 环境变量配置
  - 重试机制实现
- 添加新的API接口
  - /refresh_events
  - /get_active_events
  - /handle_event

### 2025-01-26
#### 更新一：精简界面显示
- 移除所有进度条显示，仅保留数值显示
- 简化HTML结构和JavaScript更新逻辑
- 保持所有功能的完整性
- 为后续UI扩展预留空间

### 2025-01-25
#### 更新三：修复存档系统
- 完善save_system.py的序列化/反序列化逻辑
  - 添加对所有新属性的支持（基础五维、境界系统、灵根资质、性格维度等）
  - 修复任务数据的恢复逻辑
  - 添加事件日志的完整支持
- 统一属性命名
  - destiny 改为 fortune
  - luck_sensitivity 改为 fortune_sensitivity
- 修复load_game路由参数不匹配问题
- 更新前端显示
  - 更新HTML class名称
  - 更新JavaScript属性映射

### 2025-01-25
#### 更新二：完善人物属性系统
- 数据模型更新
  - 添加基础五维属性（气血、灵力、神识、体魄、气运）
  - 实现境界系统（境界阶段、小境界、破境概率）
  - 添加灵根资质系统（五行灵根）
  - 增加性格维度系统（正邪倾向、决策风格等）
- API接口更新
  - 扩展get_status接口返回新增属性
- 前端更新
  - 添加新的状态显示区域
  - 实现属性数值实时更新
  - 优化UI布局和样式

### 2025-01-25
#### 更新一：添加存档系统
- 实现SaveSlot数据模型
- 添加存档相关API接口
- 实现存档数据序列化和压缩
- 更新前端UI，添加存档功能
- 支持多槽位存档管理
