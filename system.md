# SystemCome 系统状态文档

## 系统概述
SystemCome是一个基于LLM的游戏系统，玩家扮演"系统"角色，通过与LLM驱动的主角互动来推进故事发展。游戏通过网页端进行交互，采用类似ChatGPT的对话形式。

## 当前系统架构

### 后端架构
1. Flask Web服务器 (flask_app/app.py)
   - 提供Web API接口
   - 支持普通对话和SSE流式对话
   - 处理用户输入和系统响应
   - 处理特殊指令（/task, /modify, /query等）

2. 核心包 (flask_app/core/)
   - System: 系统控制器，整合所有组件
   - Character: 主角代理，处理角色行为和状态
   - World: 世界模型，维护世界状态
   - Task: 任务对象，管理任务系统
   - LLMService: LLM服务，处理AI生成

### 前端架构
1. 网页界面 (flask_app/templates/chat.html)
   - 响应式设计
   - 支持移动端访问
   - Markdown渲染支持

2. 交互功能 (flask_app/static/script.js)
   - 对话管理（新建、切换、删除）
   - 实时消息流处理
   - 自动滚动和加载动画
   - 移动端菜单支持

## 当前实现功能
1. 基础对话系统
   - 支持多轮对话
   - 支持流式响应
   - 支持Markdown格式化
   
2. 对话管理
   - 创建新对话
   - 切换对话
   - 删除对话
   - 对话历史保存

3. 游戏核心机制
   - 系统能量值管理
   - 主角状态管理
   - 世界状态管理
   - 任务系统
   - 特殊指令支持

4. 主角AI实现
   - 性格系统
   - 决策系统
   - 行动系统
   - 心理活动系统

5. 世界系统
   - 世界状态一致性维护
   - 历史事件记录
   - 状态查询功能

## 待实现功能
1. 系统功能
   - 游戏设置
   - 系统状态展示
   - 任务管理界面

2. 优化
   - 实现真正的流式响应
   - 优化能量值计算
   - 增强任务影响机制
   - 改进故事生成质量

3. 界面功能
   - 添加能量值显示
   - 添加任务列表界面
   - 添加世界状态展示
   - 优化特殊指令输入

## 技术债务
1. 需要添加单元测试
2. 需要实现错误处理机制
3. 需要优化数据存储方案
4. 需要实现配置管理系统
5. 需要优化异步处理机制

## 最近更新
- 2025/2/3: 添加存档功能
  - 添加存档相关命令
    - /save [存档名] - 保存游戏状态，默认存档名为default
    - /savef [存档名] - 强制保存游戏状态，会覆盖已有存档
    - /load [存档名] - 加载游戏状态，默认加载default存档
    - /listsave - 显示所有存档
  - 改进后端架构
    - System类添加存档管理功能
    - World和Character类支持状态序列化和反序列化
    - 完善日志记录
    - 添加错误处理机制
  - 存档功能特性
    - 支持多个存档，每个存档独立保存
    - 存档包含完整的游戏状态（世界、角色、系统、对话历史等）
    - 加载存档后自动设置为started状态
    - 防止意外覆盖已有存档
- 2025/2/2: 添加多剧本支持
  - 添加/story命令，支持切换不同剧本
    - 支持查看可用剧本列表
    - 支持切换到指定剧本
    - 切换剧本时自动重置游戏状态
    - 从指定剧本文件夹加载配置
  - 修改前端UI支持剧本切换
    - 左侧改为剧本列表显示
    - 点击剧本可以切换
    - 添加切换确认提示
    - 优化剧本列表样式
  - 改进后端架构
    - System类支持多剧本管理
    - World和Character类支持从指定剧本加载配置
    - 完善日志记录
    - 添加错误处理机制

- 2025/2/2: 改进状态修改反馈系统
  - 优化modify_state函数的反馈机制
    - 对于世界状态修改，直接显示具体修改内容
    - 对于角色状态修改，显示详细的属性变更差异
    - 使用LLM进行智能差异比较
    - 提供人类可读的变更说明
    - 完善日志记录

- 2025/2/2: 添加游戏重置功能
  - 添加/restart命令，支持重置游戏状态
    - 重新初始化角色状态
    - 重新初始化世界状态
    - 重置系统能量值
    - 清空对话历史
    - 重置后需要重新/start开始游戏
- 2025/2/2: 优化查询功能
  - 改进/qu命令的功能
    - 添加独立的qu命令历史记录
    - 在查询时同时使用对话历史、qu历史和世界状态
    - 让查询结果更加符合上下文
    - 提高查询结果的准确性和连贯性
    - 完善日志记录

- 2025/2/2: 优化UI界面
  - 缩小命令说明字体(从0.9em到0.8em)，提升界面整洁度
  - 优化命令列表显示效果，使其更易于阅读

- 2025/2/1: 优化状态修改系统
  - 合并modify_world和update_character_profile函数为modify_state
  - 添加自动判断修改类型的功能（世界状态/角色状态）
  - 将能量计算合并到同一个LLM请求中
  - 优化日志记录和错误处理
  - 提高代码复用性和可维护性

- 2025/2/1: 添加场景描述生成功能
  - 添加/des指令，支持生成当前场景的详细描述
    - 综合分析世界状态和角色信息
    - 生成小说风格的场景描述
    - 包含环境、氛围、人物状态等要素
    - 突出重要细节和关键信息
    - 保持文学性和画面感
    - 控制在300字以内

- 2025/2/1: 添加角色档案自动更新功能
  - 添加/upch指令，支持根据对话内容自动更新角色档案
    - 分析对话历史和总结，识别新特征
    - 自动提取新能力、特质和经历
    - 智能更新角色档案内容
    - 支持异步更新处理
    - 完整的错误处理和日志记录

- 2025/2/1: 优化Character类属性更新机制
  - 重构update_attributes函数，使用LLM直接处理属性更新
  - 移除profile_attributes的直接操作
  - 改进属性更新的日志记录
  - 支持异步属性更新处理

- 2025/2/1: 添加角色信息查询功能
  - 添加/character指令，支持查看主角完整信息
    - 显示角色档案
    - 显示当前心理状态
    - 显示角色属性
    - 显示已完成任务列表

- 2025/2/1: 完善世界观和角色设定
  - 扩展world_init.json的世界设定
    - 添加详细的地理信息和重要地区
    - 完善世界规则系统
    - 添加更多初始事件
    - 补充背景故事和世界观
  - 扩展character_init.json的角色设定
    - 添加详细的基础属性系统
    - 建立技能系统框架
    - 构建人物关系网络
    - 添加日常活动安排
    - 完善角色背景和剧情钩子
- 2025/1/31: 改进任务系统
  - 移除/task指令，支持从对话中自动识别任务
  - 添加任务完成自动检测功能
  - 实现任务奖励自动应用到角色属性
  - 在对话和故事演进中自动检查任务状态
  - 优化任务状态管理和奖励系统
- 2024/1/31: 初始化系统文档
- 完成基础对话系统实现
- 完成前端界面基本功能
- 完成LLM服务集成
- 2024/1/31: 重构系统架构
  - 创建core包，实现核心类
  - 实现System控制器
  - 实现Character主角代理
  - 实现World世界模型
  - 实现Task任务系统
  - 优化LLM服务
  - 重构app.py，支持特殊指令
- 2024/1/31: 添加日志系统
  - 实现日志配置模块
  - 为所有核心类添加日志记录
  - 记录关键操作和错误信息
  - 支持按类分类的日志文件
  - 实现日志轮转和备份
- 2025/1/31: 添加故事配置系统
  - 创建story文件夹存放配置文件
  - 添加world_init.json定义世界初始状态
  - 添加character_init.json定义角色初始状态
  - 修改World类支持从配置文件加载初始状态
  - 修改Character类支持从配置文件加载初始状态

- 2025/1/31: 改进世界状态和对话系统
  - 增强世界查询功能，保存查询结果到历史记录
  - 优化对话流处理，支持普通返回和流式返回
  - 改进异步迭代器处理机制
  - 完善日志记录
