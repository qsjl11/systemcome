<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修仙系统模拟器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div id="status-bars">
            <div class="status-item">
                <label>修为</label>
                <div class="bar-container">
                    <div class="bar cultivation" style="width: 0%"></div>
                </div>
                <span class="value">0</span>
            </div>
            <div class="status-item">
                <label>信任</label>
                <div class="bar-container">
                    <div class="bar trust" style="width: 50%"></div>
                </div>
                <span class="value">50</span>
            </div>
            <div class="status-item">
                <label>压力</label>
                <div class="bar-container">
                    <div class="bar stress" style="width: 0%"></div>
                </div>
                <span class="value">0</span>
            </div>
        </div>

        <div id="action-panel">
            <div class="task-buttons">
                <button class="btn-task" data-type="战斗">发布战斗任务</button>
                <button class="btn-task" data-type="探索">发布探索任务</button>
                <button class="btn-task" data-type="社交">发布社交任务</button>
            </div>
            <div class="save-panel">
                <button id="btn-save" onclick="showSaveDialog()">保存游戏</button>
                <button id="btn-load" onclick="showLoadDialog()">读取存档</button>
            </div>
        </div>

        <div id="save-dialog" class="dialog" style="display: none;">
            <div class="dialog-content">
                <h3>保存游戏</h3>
                <div class="save-slots"></div>
                <div class="save-input">
                    <input type="text" id="save-name" placeholder="存档名称">
                    <button onclick="saveGame()">保存</button>
                </div>
                <button class="close-btn" onclick="closeDialog('save-dialog')">关闭</button>
            </div>
        </div>

        <div id="load-dialog" class="dialog" style="display: none;">
            <div class="dialog-content">
                <h3>读取存档</h3>
                <div class="save-slots"></div>
                <button class="close-btn" onclick="closeDialog('load-dialog')">关闭</button>
            </div>
        </div>

        <div id="event-log">
            <h3>事件日志</h3>
            <div class="event-messages"></div>
        </div>
    </div>

    <style>
        .dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .dialog-content {
            position: relative;
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            border-radius: 5px;
        }
        
        .save-slots {
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .save-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background-color: #f5f5f5;
            border-radius: 3px;
        }
        
        .save-input {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .save-input input {
            flex: 1;
            padding: 5px;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .save-panel {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
    </style>

    <script>
        // 更新状态栏
        function updateStatus() {
            fetch('/get_status')
                .then(response => response.json())
                .then(data => {
                    document.querySelector('.cultivation').style.width = data.cultivation + '%';
                    document.querySelector('.trust').style.width = data.trust + '%';
                    document.querySelector('.stress').style.width = data.stress + '%';
                    
                    document.querySelectorAll('.status-item').forEach(item => {
                        const type = item.querySelector('.bar').classList[1];
                        item.querySelector('.value').textContent = data[type];
                    });
                });
        }

        // 发布任务
        document.querySelectorAll('.btn-task').forEach(button => {
            button.addEventListener('click', function() {
                const type = this.dataset.type;
                const formData = new FormData();
                formData.append('type', type);

                fetch('/issue_task', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    addEventMessage(data.message);
                    updateStatus();
                    // 获取AI响应
                    return fetch('/get_ai_action');
                })
                .then(response => response.json())
                .then(data => {
                    addEventMessage(`主角决定: ${data.action} (${data.reason})`);
                });
            });
        });

        // 添加事件消息
        function addEventMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'event-message';
            messageDiv.textContent = message;
            document.querySelector('.event-messages').prepend(messageDiv);
        }

        // 存档系统相关函数
        function showSaveDialog() {
            document.getElementById('save-dialog').style.display = 'block';
            updateSaveSlots('save-dialog');
        }

        function showLoadDialog() {
            document.getElementById('load-dialog').style.display = 'block';
            updateSaveSlots('load-dialog');
        }

        function closeDialog(dialogId) {
            document.getElementById(dialogId).style.display = 'none';
        }

        function updateSaveSlots(dialogId) {
            fetch('/get_saves')
                .then(response => response.json())
                .then(saves => {
                    const slotsContainer = document.querySelector(`#${dialogId} .save-slots`);
                    slotsContainer.innerHTML = '';
                    
                    for (let i = 1; i <= 10; i++) {
                        const save = saves.find(s => s.slot_num === i);
                        const slot = document.createElement('div');
                        slot.className = 'save-slot';
                        
                        if (save) {
                            const saveTime = new Date(save.save_time).toLocaleString();
                            slot.innerHTML = `
                                <div>
                                    <strong>${save.save_name}</strong><br>
                                    <small>${saveTime}</small>
                                </div>
                                <div>
                                    ${dialogId === 'save-dialog' 
                                        ? `<button onclick="saveGame(${i})">覆盖</button>`
                                        : `<button onclick="loadGame(${i})">读取</button>`
                                    }
                                </div>
                            `;
                        } else {
                            slot.innerHTML = `
                                <div>空存档位 ${i}</div>
                                ${dialogId === 'save-dialog' 
                                    ? `<button onclick="saveGame(${i})">保存</button>`
                                    : ''
                                }
                            `;
                        }
                        
                        slotsContainer.appendChild(slot);
                    }
                });
        }

        function saveGame(slotNum) {
            const saveName = document.getElementById('save-name').value || `存档 ${slotNum}`;
            const formData = new FormData();
            formData.append('slot_num', slotNum);
            formData.append('save_name', saveName);

            fetch('/save_game', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                addEventMessage(data.message);
                closeDialog('save-dialog');
            });
        }

        function loadGame(slotNum) {
            const formData = new FormData();
            formData.append('slot_num', slotNum);

            fetch('/load_game', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                addEventMessage(data.message);
                updateStatus();
                closeDialog('load-dialog');
            });
        }

        // 初始化
        updateStatus();
        // 定期更新状态
        setInterval(updateStatus, 5000);

        // 添加ESC键关闭对话框
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.dialog').forEach(dialog => {
                    dialog.style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>
